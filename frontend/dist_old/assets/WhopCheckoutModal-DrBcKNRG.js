import{r as s,u as A,c as w,j as e,a as F}from"./index-B3SC9TNl.js";function M(r){const a=r.replace(/[^0-9]/g,"");return a.startsWith("0")&&a.length===10?"254"+a.slice(1):a.startsWith("254")&&a.length===12?a:a.startsWith("+254")?a.slice(1):a}function E(r){return/^254[17]\d{8}$/.test(r)}function q({isOpen:r,onClose:a,onSuccess:N,amountKes:f=0,amountUsd:m=0,transactionType:I,referenceId:_="",title:L="Payment",description:j=""}){const[v,u]=s.useState("phone_input"),[i,C]=s.useState(localStorage.getItem("mpesa_phone")||""),[g,R]=s.useState(null),[x,l]=s.useState(""),[b,T]=s.useState(f),[o,S]=s.useState(m),[k,h]=s.useState(!1),n=s.useRef(null),c=s.useRef(0),{t:d}=A();s.useEffect(()=>{if(r){if(f>0){T(f);return}m>0&&(h(!0),w.post("/api/payment/quote",{amount_usd:m}).then(p=>{T(p.data.amount_kes||0),S(p.data.amount_usd||m)}).catch(()=>l("Failed to get price quote")).finally(()=>h(!1)))}},[r,f,m]),s.useEffect(()=>{r?(u("phone_input"),l(""),R(null),c.current=0):n.current&&clearInterval(n.current)},[r]),s.useEffect(()=>()=>{n.current&&clearInterval(n.current)},[]);const z=async()=>{const p=M(i);if(!E(p)){l(d("payment.invalidPhone"));return}l(""),u("stk_sent"),localStorage.setItem("mpesa_phone",i);try{const y=await w.post("/api/payment/mpesa/initiate",{phone:p,amount_kes:b,transaction_type:I,reference_id:String(_)});R(y.data.transaction_id),B(y.data.transaction_id)}catch(y){l(y.response?.data?.detail||"Failed to initiate payment"),u("failed")}},B=p=>{c.current=0,n.current=setInterval(async()=>{if(c.current++,c.current>30){clearInterval(n.current),u("expired");return}try{const y=await w.get(`/api/payment/status/${p}`),P=y.data.status;P==="completed"?(clearInterval(n.current),u("success"),setTimeout(()=>{N?.(y.data.transaction)},2e3)):P==="failed"?(clearInterval(n.current),l(y.data.message||d("payment.paymentFailed")),u("failed")):P==="expired"&&(clearInterval(n.current),u("expired"))}catch{}},3e3)},W=()=>{n.current&&clearInterval(n.current),u("phone_input"),l(""),R(null),c.current=0};return r?e.jsx("div",{className:"mpesa-modal-overlay",onClick:a,children:e.jsxs("div",{className:"mpesa-modal",onClick:p=>p.stopPropagation(),children:[e.jsx("button",{className:"mpesa-modal-close",onClick:a,children:"×"}),e.jsxs("div",{className:"mpesa-modal-header",children:[e.jsx("div",{className:"mpesa-logo",children:e.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"#43b02a",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"1",y:"4",width:"22",height:"16",rx:"2",ry:"2"}),e.jsx("line",{x1:"1",y1:"10",x2:"23",y2:"10"})]})}),e.jsx("h3",{className:"mpesa-modal-title",children:L}),j&&e.jsx("p",{className:"mpesa-modal-desc",children:j})]}),v==="phone_input"&&e.jsxs("div",{className:"mpesa-modal-body",children:[e.jsx("div",{className:"mpesa-amount-display",children:k?e.jsx("div",{className:"mpesa-quote-loading",children:"Getting price..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mpesa-amount-kes",children:["KES ",Math.ceil(b).toLocaleString()]}),o>0&&e.jsxs("div",{className:"mpesa-amount-usd",children:["(~$",o.toFixed(2)," USD)"]})]})}),e.jsx("label",{className:"mpesa-label",children:d("payment.phoneNumber")}),e.jsx("input",{type:"tel",className:"mpesa-phone-input",placeholder:d("payment.phonePlaceholder"),value:i,onChange:p=>{C(p.target.value),l("")},maxLength:13}),e.jsx("p",{className:"mpesa-phone-hint",children:"An STK push will be sent to this number"}),x&&e.jsx("div",{className:"mpesa-error",children:x}),e.jsx("button",{className:"mpesa-pay-btn",onClick:z,disabled:!i.trim()||k||b<=0,children:d("payment.pay")})]}),(v==="stk_sent"||v==="waiting")&&e.jsxs("div",{className:"mpesa-modal-body mpesa-status-screen",children:[e.jsxs("div",{className:"mpesa-waiting-icon",children:[e.jsx("div",{className:"mpesa-pulse-ring"}),e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#43b02a",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"})})]}),e.jsx("h4",{className:"mpesa-status-title",children:d("payment.checkPhone")}),e.jsx("p",{className:"mpesa-status-msg",children:"An M-Pesa payment prompt has been sent to your phone. Please enter your M-Pesa PIN to confirm the payment."}),e.jsxs("div",{className:"mpesa-spinner-row",children:[e.jsx("div",{className:"spinner",style:{width:18,height:18}}),e.jsx("span",{children:d("payment.waitingConfirmation")})]})]}),v==="success"&&e.jsxs("div",{className:"mpesa-modal-body mpesa-status-screen",children:[e.jsx("div",{className:"mpesa-success-icon",children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"#22c55e",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),e.jsx("polyline",{points:"22 4 12 14.01 9 11.01"})]})}),e.jsx("h4",{className:"mpesa-status-title mpesa-success-text",children:d("payment.paymentSuccess")}),e.jsx("p",{className:"mpesa-status-msg",children:"Your payment has been confirmed."})]}),v==="failed"&&e.jsxs("div",{className:"mpesa-modal-body mpesa-status-screen",children:[e.jsx("div",{className:"mpesa-failed-icon",children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"#ef4444",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]})}),e.jsx("h4",{className:"mpesa-status-title mpesa-failed-text",children:d("payment.paymentFailed")}),e.jsx("p",{className:"mpesa-status-msg",children:x||"The payment could not be completed."}),e.jsx("button",{className:"mpesa-retry-btn",onClick:W,children:"Try Again"})]}),v==="expired"&&e.jsxs("div",{className:"mpesa-modal-body mpesa-status-screen",children:[e.jsx("div",{className:"mpesa-expired-icon",children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"#f59e0b",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsx("h4",{className:"mpesa-status-title mpesa-expired-text",children:"Payment Timed Out"}),e.jsx("p",{className:"mpesa-status-msg",children:"The payment wasn't confirmed in time. If you completed the payment on your phone, your purchase will be credited automatically."}),e.jsx("button",{className:"mpesa-retry-btn",onClick:W,children:"Try Again"})]})]})}):null}function H({isOpen:r,onClose:a,onSuccess:N,transactionType:f,planId:m="",predictionId:I=0,amountUsd:_=0,title:L="Payment"}){const{t:j}=A(),{user:v}=F(),[u,i]=s.useState(!0),[C,g]=s.useState(""),[R,x]=s.useState(!1),[l,b]=s.useState(!1),T=s.useRef(null),o=s.useRef(null),S=s.useRef(null);return s.useEffect(()=>{if(!r){i(!0),g(""),x(!1),b(!1),S.current=null,o.current&&clearInterval(o.current);return}return(async()=>{i(!0),g("");try{const h=await w.post("/api/whop/create-checkout",{transaction_type:f,plan_id:m,prediction_id:I,amount_usd:_}),{purchase_url:n,checkout_id:c}=h.data;S.current=c,n?(T.current=window.open(n,"_blank"),i(!1),x(!0),o.current=setInterval(async()=>{try{(await w.get("/api/whop/check-payment/"+c)).data.status==="completed"&&(clearInterval(o.current),b(!0),setTimeout(()=>{N&&N()},1500))}catch{}},3e3)):(g("No checkout URL returned. Please try again."),i(!1))}catch(h){g(h.response?.data?.detail||"Failed to initialize checkout"),i(!1)}})(),()=>{o.current&&clearInterval(o.current)}},[r,f,m,I,_]),r?e.jsx("div",{style:t.overlay,onClick:k=>{k.target===k.currentTarget&&a()},children:e.jsxs("div",{style:t.modal,children:[e.jsxs("div",{style:t.header,children:[e.jsx("h3",{style:t.title,children:L}),e.jsx("button",{style:t.closeBtn,onClick:a,children:"×"})]}),u&&e.jsxs("div",{style:t.loadingContainer,children:[e.jsx("div",{className:"spinner",style:{width:32,height:32}}),e.jsx("p",{style:t.loadingText,children:j("whop.loading")})]}),C&&e.jsxs("div",{style:t.errorContainer,children:[e.jsx("p",{style:t.errorText,children:C}),e.jsx("button",{style:t.retryBtn,onClick:()=>{g(""),i(!0),x(!1)},children:j("whop.retry")})]}),l&&e.jsxs("div",{style:t.successContainer,children:[e.jsx("div",{style:t.successIcon,children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"#22c55e",strokeWidth:"2",children:[e.jsx("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),e.jsx("polyline",{points:"22 4 12 14.01 9 11.01"})]})}),e.jsx("p",{style:t.successText,children:j("whop.paymentConfirmed")}),e.jsx("p",{style:t.successSubtext,children:j("whop.processing")})]}),R&&!C&&!l&&e.jsxs("div",{style:t.waitingContainer,children:[e.jsx("div",{style:t.waitingIcon,children:e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"#3b82f6",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"1",y:"4",width:"22",height:"16",rx:"2",ry:"2"}),e.jsx("line",{x1:"1",y1:"10",x2:"23",y2:"10"})]})}),e.jsx("p",{style:t.waitingTitle,children:"Complete payment in the new tab"}),e.jsx("p",{style:t.waitingSubtext,children:"A secure Whop checkout page has opened. Complete your payment there and this page will update automatically."}),e.jsxs("div",{style:t.waitingDots,children:[e.jsx("div",{className:"spinner",style:{width:20,height:20}}),e.jsx("span",{style:t.waitingStatus,children:"Waiting for payment..."})]}),e.jsx("button",{style:t.reopenBtn,onClick:()=>{S.current&&(x(!1),i(!0),g(""),o.current&&clearInterval(o.current),(async()=>{try{const h=await w.post("/api/whop/create-checkout",{transaction_type:f,plan_id:m,prediction_id:I,amount_usd:_}),{purchase_url:n,checkout_id:c}=h.data;S.current=c,n&&(window.open(n,"_blank"),i(!1),x(!0),o.current=setInterval(async()=>{try{(await w.get("/api/whop/check-payment/"+c)).data.status==="completed"&&(clearInterval(o.current),b(!0),setTimeout(()=>{N&&N()},1500))}catch{}},3e3))}catch(h){g(h.response?.data?.detail||"Failed to open checkout"),i(!1)}})())},children:"Reopen checkout page"})]})]})}):null}const t={overlay:{position:"fixed",inset:0,background:"rgba(0, 0, 0, 0.7)",backdropFilter:"blur(4px)",zIndex:2e3,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},modal:{background:"rgba(30, 41, 59, 0.97)",backdropFilter:"blur(20px)",border:"1px solid #334155",borderRadius:"20px",padding:"0",maxWidth:"480px",width:"100%",maxHeight:"90vh",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 8px 32px rgba(0,0,0,0.5)"},header:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",borderBottom:"1px solid #334155"},title:{margin:0,fontSize:"16px",fontWeight:"600",color:"#f1f5f9"},closeBtn:{background:"none",border:"none",color:"#94a3b8",fontSize:"24px",cursor:"pointer",padding:"0 4px",lineHeight:1},loadingContainer:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"48px 20px",gap:"12px"},loadingText:{color:"#94a3b8",fontSize:"14px",margin:0},errorContainer:{display:"flex",flexDirection:"column",alignItems:"center",padding:"48px 20px",gap:"16px"},errorText:{color:"#f87171",fontSize:"14px",textAlign:"center",margin:0},retryBtn:{padding:"8px 24px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:"8px",fontSize:"14px",cursor:"pointer"},successContainer:{display:"flex",flexDirection:"column",alignItems:"center",padding:"48px 20px",gap:"12px"},successIcon:{marginBottom:"8px"},successText:{color:"#22c55e",fontSize:"18px",fontWeight:"600",margin:0},successSubtext:{color:"#94a3b8",fontSize:"14px",margin:0},waitingContainer:{display:"flex",flexDirection:"column",alignItems:"center",padding:"36px 24px",gap:"16px"},waitingIcon:{marginBottom:"4px"},waitingTitle:{color:"#f1f5f9",fontSize:"16px",fontWeight:"600",margin:0,textAlign:"center"},waitingSubtext:{color:"#94a3b8",fontSize:"13px",margin:0,textAlign:"center",lineHeight:"1.5"},waitingDots:{display:"flex",alignItems:"center",gap:"8px",marginTop:"8px"},waitingStatus:{color:"#64748b",fontSize:"13px"},reopenBtn:{padding:"8px 20px",background:"transparent",color:"#3b82f6",border:"1px solid #334155",borderRadius:"8px",fontSize:"13px",cursor:"pointer",marginTop:"8px"}};export{q as M,H as W};
