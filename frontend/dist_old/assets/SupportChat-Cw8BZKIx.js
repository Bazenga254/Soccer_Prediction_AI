import{r as n,u as ue,j as e,c as g}from"./index-B3SC9TNl.js";import{p as pe}from"./sounds-Ck9TXWp9.js";const de=[".jpg",".jpeg",".png",".gif",".webp"];function he(c){const l=/(https?:\/\/[^\s<]+)/g,o=c.split(l);return o.length===1?c:o.map((u,d)=>l.test(u)?(l.lastIndex=0,e.jsx("a",{href:u,target:"_blank",rel:"noopener noreferrer",style:{color:"#6c5ce7",textDecoration:"underline",wordBreak:"break-all"},children:u},d)):u)}function ge(c){const l=c.match(/^\[FILE:(.+?)\]\((.+?)\)$/);if(!l)return null;const o=l[1],u=l[2],d=o.substring(o.lastIndexOf(".")).toLowerCase(),v=de.includes(d);return{name:o,url:u,isImage:v}}const $=[{id:"payment",label:"Payment Related",icon:"ðŸ’³"},{id:"subscription",label:"Subscription",icon:"ðŸ’Ž"},{id:"predictions",label:"Ads / Predictions",icon:"âš½"},{id:"general",label:"General Issue",icon:"ðŸ’¬"}];function xe(){const[c,l]=n.useState(!1),[o,u]=n.useState([]),[d,v]=n.useState(""),[T,D]=n.useState(!1),[k,R]=n.useState(0),[F,O]=n.useState(!1),[y,W]=n.useState(null),[H,h]=n.useState(!1),[E,V]=n.useState(!1),[m,b]=n.useState(!1),[te,f]=n.useState(null),[z,_]=n.useState(null),[L,x]=n.useState(!1),[S,P]=n.useState(0),[G,U]=n.useState(""),[C,N]=n.useState(!1),[K,Z]=n.useState(!1),[J,X]=n.useState(!1),M=n.useRef(null),j=n.useRef(null),I=n.useRef(null),i=n.useRef(null),q=n.useRef(null),{t:A}=ue(),se=()=>{M.current&&M.current.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{se()},[o,H,L]),n.useEffect(()=>{const t=o.some(a=>a.sender==="ai"&&(a.content.includes("forwarded this conversation to a support agent")||a.content.includes("connected you with a support agent")||a.content.includes("forwarded your issue to an agent")));V(t);const s=o.find(a=>a.sender==="admin"&&a.agent_name);s&&_(s.agent_name);const r=o.find(a=>a.sender==="system");r&&(b(!0),r.content.includes("inactivity")?f("inactivity"):(f("agent_closed"),C||x(!0)))},[o,C]),n.useEffect(()=>{const t=()=>{c||w(),l(!0)};return window.addEventListener("open-support-chat",t),()=>window.removeEventListener("open-support-chat",t)},[c]);const B=n.useCallback(()=>{const t=localStorage.getItem("spark_token");if(!t)return;j.current&&j.current.close();const s=new EventSource(`/api/support/stream?token=${t}`);j.current=s,s.onmessage=r=>{try{const a=JSON.parse(r.data);a.type==="init"?R(a.unread_count||0):a.type==="new"&&(R(a.unread_count||0),a.message&&(a.message.sender!=="user"&&pe(),(a.message.sender==="ai"||a.message.sender==="admin")&&(h(!1),i.current&&clearTimeout(i.current)),a.message.sender==="system"&&(h(!1),i.current&&clearTimeout(i.current),b(!0),a.message.content.includes("inactivity")?f("inactivity"):(f("agent_closed"),N(p=>(p||x(!0),p)))),u(p=>p.some(ee=>ee.id===a.message.id)?p:[...p,a.message])))}catch{}},s.onerror=()=>{s.close(),j.current=null,I.current=setTimeout(B,5e3)}},[]);n.useEffect(()=>(B(),()=>{j.current&&j.current.close(),I.current&&clearTimeout(I.current),i.current&&clearTimeout(i.current)}),[B]),n.useEffect(()=>{(async()=>{try{const s=await g.get("/api/support/conversation-status");s.data.has_conversation&&s.data.status==="closed"&&(b(!0),f(s.data.closed_reason),s.data.assigned_agent_name&&_(s.data.assigned_agent_name))}catch{}})()},[]);const w=async()=>{O(!0);try{const t=await g.get("/api/support/messages");u(t.data.messages||[]),R(0)}catch{}O(!1)},ne=()=>{c||w(),l(!c)},ae=t=>{W(t)},Q=async t=>{if(t.preventDefault(),!(!d.trim()||T||m)){D(!0),E||(h(!0),i.current&&clearTimeout(i.current),i.current=setTimeout(()=>h(!1),15e3));try{const s={content:d.trim()};o.length===0&&y&&(s.category=y),await g.post("/api/support/send",s),v(""),await w(),h(!1),i.current&&clearTimeout(i.current)}catch(s){h(!1),i.current&&clearTimeout(i.current),s.response?.status===400&&s.response?.data?.detail?.includes("closed")&&b(!0)}D(!1)}},re=async()=>{try{await g.post("/api/support/escalate"),w()}catch{}},oe=async()=>{try{await g.post("/api/support/new-conversation"),u([]),b(!1),f(null),x(!1),P(0),U(""),N(!1),W(null),V(!1),_(null),h(!1)}catch{}},ie=async()=>{if(!(S<1)){Z(!0);try{await g.post("/api/support/rate",{rating:S,comment:G.trim()}),N(!0),x(!1)}catch(t){console.error("[Support] Rating submission error:",t.response?.data||t),N(!0),x(!1)}Z(!1)}},ce=async t=>{const s=t.target.files?.[0];if(s){if(t.target.value="",s.size>10*1024*1024){alert("File too large. Maximum size is 10MB.");return}X(!0);try{const r=new FormData;r.append("file",s),await g.post("/api/support/upload",r,{headers:{"Content-Type":"multipart/form-data"}}),await w()}catch(r){alert(r.response?.data?.detail||"Failed to upload file")}X(!1)}},le=t=>{const s=t&&!t.endsWith("Z")&&!t.includes("+")?t+"Z":t,r=Date.now()-new Date(s).getTime(),a=Math.floor(r/6e4);if(a<1)return"Now";if(a<60)return`${a}m ago`;const p=Math.floor(a/60);return p<24?`${p}h ago`:`${Math.floor(p/24)}d ago`},Y=o.length===0&&!y&&!F&&!m;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:`support-chat-fab ${k>0?"has-unread":""}`,onClick:ne,title:A("support.chatTitle"),children:[c?e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}):e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"10",x2:"15",y2:"10"}),e.jsx("line",{x1:"12",y1:"7",x2:"12",y2:"13"})]}),k>0&&!c&&e.jsx("span",{className:"support-chat-badge",children:k>9?"9+":k})]}),c&&e.jsxs("div",{className:"support-chat-window",children:[e.jsxs("div",{className:"support-chat-header",children:[e.jsxs("div",{className:"support-chat-header-info",children:[e.jsx("span",{className:"support-chat-header-icon",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),e.jsxs("div",{children:[e.jsx("strong",{children:A("support.chatTitle")}),e.jsx("span",{className:"support-chat-status",children:m?"Conversation ended":E?z?`Agent: ${z}`:"Connected to agent":"Powered by Spark AI"})]})]}),e.jsx("button",{className:"support-chat-close",onClick:()=>l(!1),children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsxs("div",{className:"support-chat-messages",children:[F?e.jsx("div",{className:"support-chat-loading",children:"Loading..."}):Y?e.jsxs("div",{className:"support-chat-categories",children:[e.jsx("p",{className:"support-chat-categories-title",children:"Hi there! How can we help you?"}),e.jsx("p",{className:"support-chat-categories-sub",children:"Select a topic to get started:"}),e.jsx("div",{className:"support-chat-category-grid",children:$.map(t=>e.jsxs("button",{className:"support-chat-category-btn",onClick:()=>ae(t.id),children:[e.jsx("span",{className:"support-cat-icon",children:t.icon}),e.jsx("span",{children:t.label})]},t.id))})]}):e.jsxs(e.Fragment,{children:[o.length===0&&y&&!m&&e.jsxs("div",{className:"support-chat-empty",children:[e.jsx("span",{className:"support-category-tag",children:$.find(t=>t.id===y)?.label}),e.jsx("p",{children:"Describe your issue and we'll get back to you shortly."})]}),o.map((t,s)=>e.jsxs("div",{className:`support-bubble ${t.sender}`,children:[t.sender==="ai"&&(s===0||o[s-1]?.sender!=="ai")&&e.jsxs("span",{className:"support-ai-label",children:[e.jsx("span",{className:"support-ai-icon",children:"âœ¦"})," Spark AI"]}),t.sender==="admin"&&(s===0||o[s-1]?.sender!=="admin"||o[s-1]?.agent_name!==t.agent_name)&&e.jsx("span",{className:"support-agent-label",children:t.agent_name?`Agent: ${t.agent_name}`:"Support Agent"}),t.sender==="system"&&e.jsx("span",{className:"support-system-label",children:"System"}),s===0&&t.category&&e.jsx("span",{className:"support-category-tag",children:$.find(r=>r.id===t.category)?.label||t.category}),(()=>{const r=ge(t.content);return r?r.isImage?e.jsxs("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:"support-file-link",children:[e.jsx("img",{src:r.url,alt:r.name,className:"support-file-image"}),e.jsx("span",{className:"support-file-name",children:r.name})]}):e.jsxs("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:"support-file-link",children:[e.jsx("span",{className:"support-file-icon",children:"ðŸ“Ž"}),e.jsx("span",{className:"support-file-name",children:r.name})]}):e.jsx("p",{children:he(t.content)})})(),e.jsx("span",{className:"support-bubble-time",children:le(t.created_at)})]},t.id)),H&&e.jsxs("div",{className:"support-bubble ai support-typing-bubble",children:[e.jsxs("span",{className:"support-ai-label",children:[e.jsx("span",{className:"support-ai-icon",children:"âœ¦"})," Spark AI"]}),e.jsxs("div",{className:"support-typing-indicator",children:[e.jsx("span",{className:"support-typing-dot"}),e.jsx("span",{className:"support-typing-dot"}),e.jsx("span",{className:"support-typing-dot"})]})]}),m&&!L&&e.jsxs("div",{className:"support-chat-closed",children:[e.jsx("p",{children:te==="inactivity"?"This conversation was closed due to inactivity.":C?"Thank you for your feedback!":"This conversation has ended."}),e.jsx("button",{className:"support-new-chat-btn",onClick:oe,children:"Start New Conversation"})]}),L&&!C&&e.jsxs("div",{className:"support-rating-prompt",children:[e.jsx("p",{className:"support-rating-title",children:"How was your experience?"}),e.jsx("div",{className:"support-rating-stars",children:[1,2,3,4,5].map(t=>e.jsx("button",{className:`support-star ${S>=t?"active":""}`,onClick:()=>P(t),children:"â˜…"},t))}),e.jsx("textarea",{className:"support-rating-comment",placeholder:"Optional: Tell us more about your experience...",value:G,onChange:t=>U(t.target.value),rows:2,maxLength:500}),e.jsxs("div",{className:"support-rating-actions",children:[e.jsx("button",{className:"support-rating-skip",onClick:()=>{x(!1),N(!0)},children:"Skip"}),e.jsx("button",{className:"support-rating-submit",onClick:ie,disabled:S<1||K,children:K?"Submitting...":"Submit Rating"})]})]})]}),e.jsx("div",{ref:M})]}),!Y&&!m&&e.jsxs("div",{className:"support-chat-bottom",children:[e.jsxs("form",{className:"support-chat-input",onSubmit:Q,children:[e.jsx("input",{type:"file",ref:q,style:{display:"none"},onChange:ce,accept:".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx"}),e.jsx("button",{type:"button",className:"support-attach-btn",onClick:()=>q.current?.click(),disabled:J,title:"Attach file (max 10MB)",children:J?e.jsx("span",{className:"support-attach-spinner"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"})})}),e.jsx("textarea",{value:d,onChange:t=>{v(t.target.value),t.target.style.height="auto",t.target.style.height=Math.min(t.target.scrollHeight,120)+"px"},onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),d.trim()&&!T&&Q(t))},placeholder:A("support.placeholder"),maxLength:2e3,autoFocus:!0,rows:1}),e.jsx("button",{type:"submit",disabled:!d.trim()||T,children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),e.jsx("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]}),!E&&o.length>0&&e.jsx("button",{className:"support-escalate-btn",onClick:re,children:"Talk to a person"})]})]})]})}export{xe as default};
